<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentStyleType="text/css" height="1365px" preserveAspectRatio="none" style="width:2297px;height:1365px;background:#FFFFFF;" version="1.1" viewBox="0 0 2297 1365" width="2297px" zoomAndPan="magnify"><defs/><g><rect fill="none" height="26.2969" id="_title" style="stroke:none;stroke-width:1.0;" width="309" x="990.25" y="10"/><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="299" x="995.25" y="27.9951">Send Message (Online/Offline Branch)</text><rect fill="#FFFFFF" height="956.6563" style="stroke:#181818;stroke-width:1.0;" width="10" x="393.5" y="192.8594"/><rect fill="#FFFFFF" height="239.9297" style="stroke:#181818;stroke-width:1.0;" width="10" x="1843" y="1035.1172"/><rect fill="none" height="190.9297" style="stroke:#000000;stroke-width:1.5;" width="554.5" x="1221.5" y="452.7891"/><rect fill="none" height="247.8672" style="stroke:#000000;stroke-width:1.5;" width="1965.5" x="315" y="657.7188"/><rect fill="none" height="103.5313" style="stroke:#000000;stroke-width:1.5;" width="514.5" x="1766" y="1164.5156"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="27" x2="27" y1="118.5938" y2="1285.0469"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="398" x2="398" y1="118.5938" y2="1285.0469"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="786.5" x2="786.5" y1="118.5938" y2="1285.0469"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="1159.5" x2="1159.5" y1="118.5938" y2="1285.0469"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="1293.5" x2="1293.5" y1="118.5938" y2="1285.0469"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="1622" x2="1622" y1="118.5938" y2="1285.0469"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="1726" x2="1726" y1="118.5938" y2="1285.0469"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="1848" x2="1848" y1="118.5938" y2="1285.0469"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="2188.5" x2="2188.5" y1="118.5938" y2="1285.0469"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="39" x="5" y="115.292">Client</text><ellipse cx="27.5" cy="50.7969" fill="#E2E2F0" rx="8" ry="8" style="stroke:#181818;stroke-width:0.5;"/><path d="M27.5,58.7969 L27.5,85.7969 M14.5,66.7969 L40.5,66.7969 M27.5,85.7969 L14.5,100.7969 M27.5,85.7969 L40.5,100.7969 " fill="none" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="39" x="5" y="1297.042">Client</text><ellipse cx="27.5" cy="1308.8438" fill="#E2E2F0" rx="8" ry="8" style="stroke:#181818;stroke-width:0.5;"/><path d="M27.5,1316.8438 L27.5,1343.8438 M14.5,1324.8438 L40.5,1324.8438 M27.5,1343.8438 L14.5,1358.8438 M27.5,1343.8438 L40.5,1358.8438 " fill="none" style="stroke:#181818;stroke-width:0.5;"/><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="147" x="325" y="87.2969"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="133" x="332" y="107.292">WorkerThread (Ws)</text><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="147" x="325" y="1284.0469"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="133" x="332" y="1304.042">WorkerThread (Ws)</text><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="152" x="710.5" y="87.2969"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="138" x="717.5" y="107.292">ClientState (sender)</text><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="152" x="710.5" y="1284.0469"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="138" x="717.5" y="1304.042">ClientState (sender)</text><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="124" x="1097.5" y="87.2969"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="110" x="1104.5" y="107.292">ProtocolHandler</text><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="124" x="1097.5" y="1284.0469"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="110" x="1104.5" y="1304.042">ProtocolHandler</text><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="124" x="1231.5" y="87.2969"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="110" x="1238.5" y="107.292">MessageRouter</text><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="124" x="1231.5" y="1284.0469"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="110" x="1238.5" y="1304.042">MessageRouter</text><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="107" x="1569" y="87.2969"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="93" x="1576" y="107.292">CryptoEngine</text><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="107" x="1569" y="1284.0469"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="93" x="1576" y="1304.042">CryptoEngine</text><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="80" x="1686" y="87.2969"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="66" x="1693" y="107.292">Database</text><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="80" x="1686" y="1284.0469"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="66" x="1693" y="1304.042">Database</text><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="144" x="1776" y="87.2969"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="130" x="1783" y="107.292">WorkerThread (Wr)</text><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="144" x="1776" y="1284.0469"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="130" x="1783" y="1304.042">WorkerThread (Wr)</text><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="163" x="2107.5" y="87.2969"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="149" x="2114.5" y="107.292">ClientState (recipient)</text><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="163" x="2107.5" y="1284.0469"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="149" x="2114.5" y="1304.042">ClientState (recipient)</text><rect fill="#FFFFFF" height="956.6563" style="stroke:#181818;stroke-width:1.0;" width="10" x="393.5" y="192.8594"/><rect fill="#FFFFFF" height="239.9297" style="stroke:#181818;stroke-width:1.0;" width="10" x="1843" y="1035.1172"/><rect fill="#EEEEEE" height="3" style="stroke:#EEEEEE;stroke-width:1.0;" width="2290.5" x="0" y="149.1602"/><line style="stroke:#000000;stroke-width:1.0;" x1="0" x2="2290.5" y1="149.1602" y2="149.1602"/><line style="stroke:#000000;stroke-width:1.0;" x1="0" x2="2290.5" y1="152.1602" y2="152.1602"/><rect fill="#EEEEEE" height="23.1328" style="stroke:#000000;stroke-width:2.0;" width="244" x="1023.25" y="138.5938"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="225" x="1029.25" y="154.6606">Sender issues SEND_MESSAGE</text><polygon fill="#181818" points="381.5,188.8594,391.5,192.8594,381.5,196.8594,385.5,192.8594" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="27.5" x2="387.5" y1="192.8594" y2="192.8594"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="347" x="34.5" y="187.7935">[len][{"type":"SEND_MESSAGE","recipient","content"}]</text><rect fill="#EEEEEE" height="3" style="stroke:#EEEEEE;stroke-width:1.0;" width="2290.5" x="0" y="221.4258"/><line style="stroke:#000000;stroke-width:1.0;" x1="0" x2="2290.5" y1="221.4258" y2="221.4258"/><line style="stroke:#000000;stroke-width:1.0;" x1="0" x2="2290.5" y1="224.4258" y2="224.4258"/><rect fill="#EEEEEE" height="23.1328" style="stroke:#000000;stroke-width:2.0;" width="141" x="1074.75" y="210.8594"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="122" x="1080.75" y="226.9263">Parse / Dispatch</text><line style="stroke:#181818;stroke-width:1.0;" x1="403.5" x2="445.5" y1="265.125" y2="265.125"/><line style="stroke:#181818;stroke-width:1.0;" x1="445.5" x2="445.5" y1="265.125" y2="278.125"/><line style="stroke:#181818;stroke-width:1.0;" x1="404.5" x2="445.5" y1="278.125" y2="278.125"/><polygon fill="#181818" points="414.5,274.125,404.5,278.125,414.5,282.125,410.5,278.125" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="144" x="410.5" y="260.0591">epoll_wait() → EPOLLIN</text><polygon fill="#181818" points="774.5,303.2578,784.5,307.2578,774.5,311.2578,778.5,307.2578" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="403.5" x2="780.5" y1="307.2578" y2="307.2578"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="227" x="410.5" y="302.1919">handleReadEvent() → extract frame</text><polygon fill="#181818" points="1147.5,332.3906,1157.5,336.3906,1147.5,340.3906,1151.5,336.3906" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="786.5" x2="1153.5" y1="336.3906" y2="336.3906"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="349" x="793.5" y="331.3247">parseCommand(json) → Command{SEND_MESSAGE}</text><polygon fill="#181818" points="414.5,361.5234,404.5,365.5234,414.5,369.5234,410.5,365.5234" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="408.5" x2="785.5" y1="365.5234" y2="365.5234"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="196" x="420.5" y="360.4575">processCommand(state, cmd)</text><rect fill="#EEEEEE" height="3" style="stroke:#EEEEEE;stroke-width:1.0;" width="2290.5" x="0" y="394.0898"/><line style="stroke:#000000;stroke-width:1.0;" x1="0" x2="2290.5" y1="394.0898" y2="394.0898"/><line style="stroke:#000000;stroke-width:1.0;" x1="0" x2="2290.5" y1="397.0898" y2="397.0898"/><rect fill="#EEEEEE" height="23.1328" style="stroke:#000000;stroke-width:2.0;" width="62" x="1114.25" y="383.5234"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="43" x="1120.25" y="399.5903">Route</text><polygon fill="#181818" points="1281.5,433.7891,1291.5,437.7891,1281.5,441.7891,1285.5,437.7891" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="403.5" x2="1287.5" y1="437.7891" y2="437.7891"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="265" x="410.5" y="432.7231">routeMessage(sender, recipient, content)</text><path d="M1221.5,452.7891 L1469.5,452.7891 L1469.5,459.9219 L1459.5,469.9219 L1221.5,469.9219 L1221.5,452.7891 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.5;"/><rect fill="none" height="190.9297" style="stroke:#000000;stroke-width:1.5;" width="554.5" x="1221.5" y="452.7891"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="203" x="1236.5" y="465.856">Encrypt + Persist + Lookup</text><polygon fill="#181818" points="1610.5,502.1875,1620.5,506.1875,1610.5,510.1875,1614.5,506.1875" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="1293.5" x2="1616.5" y1="506.1875" y2="506.1875"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="164" x="1300.5" y="485.9888">encryptMessage(content)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="188" x="1300.5" y="501.1216">(secretbox nonce||ciphertext)</text><polygon fill="#181818" points="1304.5,531.3203,1294.5,535.3203,1304.5,539.3203,1300.5,535.3203" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1298.5" x2="1621.5" y1="535.3203" y2="535.3203"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="51" x="1310.5" y="530.2544">encBlob</text><polygon fill="#181818" points="1714,560.4531,1724,564.4531,1714,568.4531,1718,564.4531" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="1293.5" x2="1720" y1="564.4531" y2="564.4531"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="390" x="1300.5" y="559.3872">insertMessage(sender_id, recipient_id, encBlob, delivered=0)</text><polygon fill="#181818" points="1304.5,589.5859,1294.5,593.5859,1304.5,597.5859,1300.5,593.5859" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1298.5" x2="1725" y1="593.5859" y2="593.5859"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="77" x="1310.5" y="588.52">message_id</text><line style="stroke:#181818;stroke-width:1.0;" x1="1293.5" x2="1335.5" y1="622.7188" y2="622.7188"/><line style="stroke:#181818;stroke-width:1.0;" x1="1335.5" x2="1335.5" y1="622.7188" y2="635.7188"/><line style="stroke:#181818;stroke-width:1.0;" x1="1294.5" x2="1335.5" y1="635.7188" y2="635.7188"/><polygon fill="#181818" points="1304.5,631.7188,1294.5,635.7188,1304.5,639.7188,1300.5,635.7188" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="315" x="1300.5" y="617.6528">lock(clientsMutex); lookup activeClients[recipient]</text><path d="M315,657.7188 L379,657.7188 L379,664.8516 L369,674.8516 L315,674.8516 L315,657.7188 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.5;"/><rect fill="none" height="247.8672" style="stroke:#000000;stroke-width:1.5;" width="1965.5" x="315" y="657.7188"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="19" x="330" y="670.7856">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="262" x="394" y="669.9292">[recipient online (activeClients has CSr)]</text><line style="stroke:#181818;stroke-width:1.0;" x1="1293.5" x2="1335.5" y1="695.9844" y2="695.9844"/><line style="stroke:#181818;stroke-width:1.0;" x1="1335.5" x2="1335.5" y1="695.9844" y2="708.9844"/><line style="stroke:#181818;stroke-width:1.0;" x1="1294.5" x2="1335.5" y1="708.9844" y2="708.9844"/><polygon fill="#181818" points="1304.5,704.9844,1294.5,708.9844,1304.5,712.9844,1300.5,708.9844" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="187" x="1300.5" y="690.9185">get CSr; unlock(clientsMutex)</text><polygon fill="#181818" points="2177,749.25,2187,753.25,2177,757.25,2181,753.25" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="1293.5" x2="2183" y1="753.25" y2="753.25"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="333" x="1300.5" y="733.0513">queueResponse({"type":"INCOMING_MESSAGE",...})</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="199" x="1300.5" y="748.1841">(enqueue plaintext for delivery)</text><polygon fill="#181818" points="1836,778.3828,1846,782.3828,1836,786.3828,1840,782.3828" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="1293.5" x2="1842" y1="782.3828" y2="782.3828"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="305" x="1300.5" y="777.3169">epoll_ctl(EPOLL_CTL_MOD, r_fd, add EPOLLOUT)</text><polygon fill="#181818" points="414.5,807.5156,404.5,811.5156,414.5,815.5156,410.5,811.5156" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="408.5" x2="1292.5" y1="811.5156" y2="811.5156"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="149" x="420.5" y="806.4497">delivered=true, msg_id</text><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="315" x2="2280.5" y1="820.5156" y2="820.5156"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="113" x="320" y="830.7261">[recipient offline]</text><line style="stroke:#181818;stroke-width:1.0;" x1="1293.5" x2="1335.5" y1="855.4531" y2="855.4531"/><line style="stroke:#181818;stroke-width:1.0;" x1="1335.5" x2="1335.5" y1="855.4531" y2="868.4531"/><line style="stroke:#181818;stroke-width:1.0;" x1="1294.5" x2="1335.5" y1="868.4531" y2="868.4531"/><polygon fill="#181818" points="1304.5,864.4531,1294.5,868.4531,1304.5,872.4531,1300.5,868.4531" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="131" x="1300.5" y="850.3872">unlock(clientsMutex)</text><polygon fill="#181818" points="414.5,893.5859,404.5,897.5859,414.5,901.5859,410.5,897.5859" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="408.5" x2="1292.5" y1="897.5859" y2="897.5859"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="153" x="420.5" y="892.52">delivered=false, msg_id</text><rect fill="#EEEEEE" height="3" style="stroke:#EEEEEE;stroke-width:1.0;" width="2290.5" x="0" y="933.1523"/><line style="stroke:#000000;stroke-width:1.0;" x1="0" x2="2290.5" y1="933.1523" y2="933.1523"/><line style="stroke:#000000;stroke-width:1.0;" x1="0" x2="2290.5" y1="936.1523" y2="936.1523"/><rect fill="#EEEEEE" height="23.1328" style="stroke:#000000;stroke-width:2.0;" width="144" x="1073.25" y="922.5859"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="125" x="1079.25" y="938.6528">Sender response</text><polygon fill="#181818" points="1147.5,972.8516,1157.5,976.8516,1147.5,980.8516,1151.5,976.8516" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="403.5" x2="1153.5" y1="976.8516" y2="976.8516"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="557" x="410.5" y="971.7856">serializeResponse(SEND_MESSAGE_RESPONSE{success:true, delivered, message_id})</text><polygon fill="#181818" points="414.5,1001.9844,404.5,1005.9844,414.5,1009.9844,410.5,1005.9844" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="408.5" x2="1158.5" y1="1005.9844" y2="1005.9844"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="88" x="420.5" y="1000.9185">jsonResponse</text><polygon fill="#181818" points="774.5,1031.1172,784.5,1035.1172,774.5,1039.1172,778.5,1035.1172" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="403.5" x2="780.5" y1="1035.1172" y2="1035.1172"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="359" x="410.5" y="1030.0513">queueResponse(jsonResponse); epoll_ctl add EPOLLOUT</text><rect fill="#EEEEEE" height="3" style="stroke:#EEEEEE;stroke-width:1.0;" width="2290.5" x="0" y="1063.6836"/><line style="stroke:#000000;stroke-width:1.0;" x1="0" x2="2290.5" y1="1063.6836" y2="1063.6836"/><line style="stroke:#000000;stroke-width:1.0;" x1="0" x2="2290.5" y1="1066.6836" y2="1066.6836"/><rect fill="#EEEEEE" height="23.1328" style="stroke:#000000;stroke-width:2.0;" width="114" x="1088.25" y="1053.1172"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="95" x="1094.25" y="1069.1841">Flush sender</text><line style="stroke:#181818;stroke-width:1.0;" x1="403.5" x2="445.5" y1="1107.3828" y2="1107.3828"/><line style="stroke:#181818;stroke-width:1.0;" x1="445.5" x2="445.5" y1="1107.3828" y2="1120.3828"/><line style="stroke:#181818;stroke-width:1.0;" x1="404.5" x2="445.5" y1="1120.3828" y2="1120.3828"/><polygon fill="#181818" points="414.5,1116.3828,404.5,1120.3828,414.5,1124.3828,410.5,1120.3828" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="158" x="410.5" y="1102.3169">epoll_wait() → EPOLLOUT</text><polygon fill="#181818" points="774.5,1145.5156,784.5,1149.5156,774.5,1153.5156,778.5,1149.5156" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="398.5" x2="780.5" y1="1149.5156" y2="1149.5156"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="278" x="405.5" y="1144.4497">handleWriteEvent() → flush; drop EPOLLOUT</text><path d="M1766,1164.5156 L1830,1164.5156 L1830,1171.6484 L1820,1181.6484 L1766,1181.6484 L1766,1164.5156 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.5;"/><rect fill="none" height="103.5313" style="stroke:#000000;stroke-width:1.5;" width="514.5" x="1766" y="1164.5156"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="19" x="1781" y="1177.5825">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="111" x="1845" y="1176.7261">[recipient online]</text><line style="stroke:#181818;stroke-width:1.0;" x1="1853" x2="1895" y1="1202.7813" y2="1202.7813"/><line style="stroke:#181818;stroke-width:1.0;" x1="1895" x2="1895" y1="1202.7813" y2="1215.7813"/><line style="stroke:#181818;stroke-width:1.0;" x1="1854" x2="1895" y1="1215.7813" y2="1215.7813"/><polygon fill="#181818" points="1864,1211.7813,1854,1215.7813,1864,1219.7813,1860,1215.7813" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="186" x="1860" y="1197.7153">epoll_wait() → r_fd EPOLLOUT</text><polygon fill="#181818" points="2177,1256.0469,2187,1260.0469,2177,1264.0469,2181,1260.0469" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="1853" x2="2183" y1="1260.0469" y2="1260.0469"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="312" x="1860" y="1239.8481">handleWriteEvent() → send INCOMING_MESSAGE</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="289" x="1860" y="1254.981">until empty/EAGAIN; drop EPOLLOUT if empty</text><!--MD5=[ec47b6972ef1981e6b4c66bb37c640c8]
@startuml
title Send Message (Online/Offline Branch)

actor Client
participant "WorkerThread (Ws)" as Ws
participant "ClientState (sender)" as CSs
participant ProtocolHandler as PH
participant MessageRouter as MR
participant CryptoEngine as CE
participant Database as DB
participant "WorkerThread (Wr)" as Wr
participant "ClientState (recipient)" as CSr

== Sender issues SEND_MESSAGE ==
Client -> Ws: [len][{"type":"SEND_MESSAGE","recipient","content"}]

== Parse / Dispatch ==
activate Ws
Ws -> Ws: epoll_wait() → EPOLLIN
Ws -> CSs: handleReadEvent() → extract frame
CSs -> PH: parseCommand(json) → Command{SEND_MESSAGE}
CSs -> Ws: processCommand(state, cmd)

== Route ==
Ws -> MR: routeMessage(sender, recipient, content)

group Encrypt + Persist + Lookup
  MR -> CE: encryptMessage(content)\n(secretbox nonce||ciphertext)
  CE - -> MR: encBlob
  MR -> DB: insertMessage(sender_id, recipient_id, encBlob, delivered=0)
  DB - -> MR: message_id
  MR -> MR: lock(clientsMutex); lookup activeClients[recipient]
end

alt recipient online (activeClients has CSr)
  MR -> MR: get CSr; unlock(clientsMutex)
  MR -> CSr: queueResponse({"type":"INCOMING_MESSAGE",...})\n(enqueue plaintext for delivery)
  ' Notify recipient worker to enable EPOLLOUT:
  MR -> Wr: epoll_ctl(EPOLL_CTL_MOD, r_fd, add EPOLLOUT)
  MR - -> Ws: delivered=true, msg_id
else recipient offline
  MR -> MR: unlock(clientsMutex)
  MR - -> Ws: delivered=false, msg_id
end

== Sender response ==
Ws -> PH: serializeResponse(SEND_MESSAGE_RESPONSE{success:true, delivered, message_id})
PH - -> Ws: jsonResponse
Ws -> CSs: queueResponse(jsonResponse); epoll_ctl add EPOLLOUT

== Flush sender ==
activate Wr
Ws -> Ws: epoll_wait() → EPOLLOUT
Ws -> CSs: handleWriteEvent() → flush; drop EPOLLOUT
deactivate Ws

alt recipient online 
Wr -> Wr: epoll_wait() → r_fd EPOLLOUT
Wr -> CSr: handleWriteEvent() → send INCOMING_MESSAGE\nuntil empty/EAGAIN; drop EPOLLOUT if empty
end
deactivate Wr
@enduml

@startuml
title Send Message (Online/Offline Branch)

actor Client
participant "WorkerThread (Ws)" as Ws
participant "ClientState (sender)" as CSs
participant ProtocolHandler as PH
participant MessageRouter as MR
participant CryptoEngine as CE
participant Database as DB
participant "WorkerThread (Wr)" as Wr
participant "ClientState (recipient)" as CSr

== Sender issues SEND_MESSAGE ==
Client -> Ws: [len][{"type":"SEND_MESSAGE","recipient","content"}]

== Parse / Dispatch ==
activate Ws
Ws -> Ws: epoll_wait() → EPOLLIN
Ws -> CSs: handleReadEvent() → extract frame
CSs -> PH: parseCommand(json) → Command{SEND_MESSAGE}
CSs -> Ws: processCommand(state, cmd)

== Route ==
Ws -> MR: routeMessage(sender, recipient, content)

group Encrypt + Persist + Lookup
  MR -> CE: encryptMessage(content)\n(secretbox nonce||ciphertext)
  CE - -> MR: encBlob
  MR -> DB: insertMessage(sender_id, recipient_id, encBlob, delivered=0)
  DB - -> MR: message_id
  MR -> MR: lock(clientsMutex); lookup activeClients[recipient]
end

alt recipient online (activeClients has CSr)
  MR -> MR: get CSr; unlock(clientsMutex)
  MR -> CSr: queueResponse({"type":"INCOMING_MESSAGE",...})\n(enqueue plaintext for delivery)
  MR -> Wr: epoll_ctl(EPOLL_CTL_MOD, r_fd, add EPOLLOUT)
  MR - -> Ws: delivered=true, msg_id
else recipient offline
  MR -> MR: unlock(clientsMutex)
  MR - -> Ws: delivered=false, msg_id
end

== Sender response ==
Ws -> PH: serializeResponse(SEND_MESSAGE_RESPONSE{success:true, delivered, message_id})
PH - -> Ws: jsonResponse
Ws -> CSs: queueResponse(jsonResponse); epoll_ctl add EPOLLOUT

== Flush sender ==
activate Wr
Ws -> Ws: epoll_wait() → EPOLLOUT
Ws -> CSs: handleWriteEvent() → flush; drop EPOLLOUT
deactivate Ws

alt recipient online 
Wr -> Wr: epoll_wait() → r_fd EPOLLOUT
Wr -> CSr: handleWriteEvent() → send INCOMING_MESSAGE\nuntil empty/EAGAIN; drop EPOLLOUT if empty
end
deactivate Wr
@enduml

PlantUML version 1.2022.7(Mon Aug 22 17:01:30 UTC 2022)
(GPL source distribution)
Java Runtime: OpenJDK Runtime Environment
JVM: OpenJDK 64-Bit Server VM
Default Encoding: UTF-8
Language: en
Country: null
--></g></svg>