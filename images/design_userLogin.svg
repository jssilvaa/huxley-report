<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentStyleType="text/css" height="1145px" preserveAspectRatio="none" style="width:1732px;height:1145px;background:#FFFFFF;" version="1.1" viewBox="0 0 1732 1145" width="1732px" zoomAndPan="magnify"><defs/><g><rect fill="none" height="26.2969" id="_title" style="stroke:none;stroke-width:1.0;" width="95" x="814.75" y="10"/><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="85" x="819.75" y="27.9951">User Login</text><rect fill="#FFFFFF" height="854.2578" style="stroke:#181818;stroke-width:1.0;" width="10" x="346.5" y="192.8594"/><rect fill="none" height="322.2656" style="stroke:#000000;stroke-width:1.5;" width="1413.5" x="272" y="582.3203"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="27" x2="27" y1="118.5938" y2="1065.1172"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="351" x2="351" y1="118.5938" y2="1065.1172"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="739.5" x2="739.5" y1="118.5938" y2="1065.1172"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="1044.5" x2="1044.5" y1="118.5938" y2="1065.1172"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="1169.5" x2="1169.5" y1="118.5938" y2="1065.1172"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="1294.5" x2="1294.5" y1="118.5938" y2="1065.1172"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="1680.5" x2="1680.5" y1="118.5938" y2="1065.1172"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="39" x="5" y="115.292">Client</text><ellipse cx="27.5" cy="50.7969" fill="#E2E2F0" rx="8" ry="8" style="stroke:#181818;stroke-width:0.5;"/><path d="M27.5,58.7969 L27.5,85.7969 M14.5,66.7969 L40.5,66.7969 M27.5,85.7969 L14.5,100.7969 M27.5,85.7969 L40.5,100.7969 " fill="none" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="39" x="5" y="1077.1123">Client</text><ellipse cx="27.5" cy="1088.9141" fill="#E2E2F0" rx="8" ry="8" style="stroke:#181818;stroke-width:0.5;"/><path d="M27.5,1096.9141 L27.5,1123.9141 M14.5,1104.9141 L40.5,1104.9141 M27.5,1123.9141 L14.5,1138.9141 M27.5,1123.9141 L40.5,1138.9141 " fill="none" style="stroke:#181818;stroke-width:0.5;"/><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="139" x="282" y="87.2969"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="125" x="289" y="107.292">WorkerThread (W)</text><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="139" x="282" y="1064.1172"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="125" x="289" y="1084.1123">WorkerThread (W)</text><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="152" x="663.5" y="87.2969"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="138" x="670.5" y="107.292">ClientState (sender)</text><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="152" x="663.5" y="1064.1172"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="138" x="670.5" y="1084.1123">ClientState (sender)</text><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="124" x="982.5" y="87.2969"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="110" x="989.5" y="107.292">ProtocolHandler</text><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="124" x="982.5" y="1064.1172"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="110" x="989.5" y="1084.1123">ProtocolHandler</text><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="106" x="1116.5" y="87.2969"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="92" x="1123.5" y="107.292">AuthManager</text><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="106" x="1116.5" y="1064.1172"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="92" x="1123.5" y="1084.1123">AuthManager</text><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="124" x="1232.5" y="87.2969"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="110" x="1239.5" y="107.292">MessageRouter</text><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="124" x="1232.5" y="1064.1172"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="110" x="1239.5" y="1084.1123">MessageRouter</text><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="80" x="1640.5" y="87.2969"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="66" x="1647.5" y="107.292">Database</text><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="80" x="1640.5" y="1064.1172"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="66" x="1647.5" y="1084.1123">Database</text><rect fill="#FFFFFF" height="854.2578" style="stroke:#181818;stroke-width:1.0;" width="10" x="346.5" y="192.8594"/><rect fill="#EEEEEE" height="3" style="stroke:#EEEEEE;stroke-width:1.0;" width="1725.5" x="0" y="149.1602"/><line style="stroke:#000000;stroke-width:1.0;" x1="0" x2="1725.5" y1="149.1602" y2="149.1602"/><line style="stroke:#000000;stroke-width:1.0;" x1="0" x2="1725.5" y1="152.1602" y2="152.1602"/><rect fill="#EEEEEE" height="23.1328" style="stroke:#000000;stroke-width:2.0;" width="89" x="818.25" y="138.5938"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="70" x="824.25" y="154.6606">TCP Send</text><polygon fill="#181818" points="334.5,188.8594,344.5,192.8594,334.5,196.8594,338.5,192.8594" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="27.5" x2="340.5" y1="192.8594" y2="192.8594"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="300" x="34.5" y="187.7935">[len][{"type":"LOGIN","username","password"}]</text><rect fill="#EEEEEE" height="3" style="stroke:#EEEEEE;stroke-width:1.0;" width="1725.5" x="0" y="221.4258"/><line style="stroke:#000000;stroke-width:1.0;" x1="0" x2="1725.5" y1="221.4258" y2="221.4258"/><line style="stroke:#000000;stroke-width:1.0;" x1="0" x2="1725.5" y1="224.4258" y2="224.4258"/><rect fill="#EEEEEE" height="23.1328" style="stroke:#000000;stroke-width:2.0;" width="104" x="810.75" y="210.8594"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="85" x="816.75" y="226.9263">Read/Parse</text><line style="stroke:#181818;stroke-width:1.0;" x1="356.5" x2="398.5" y1="265.125" y2="265.125"/><line style="stroke:#181818;stroke-width:1.0;" x1="398.5" x2="398.5" y1="265.125" y2="278.125"/><line style="stroke:#181818;stroke-width:1.0;" x1="357.5" x2="398.5" y1="278.125" y2="278.125"/><polygon fill="#181818" points="367.5,274.125,357.5,278.125,367.5,282.125,363.5,278.125" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="144" x="363.5" y="260.0591">epoll_wait() → EPOLLIN</text><polygon fill="#181818" points="727.5,303.2578,737.5,307.2578,727.5,311.2578,731.5,307.2578" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="356.5" x2="733.5" y1="307.2578" y2="307.2578"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="261" x="363.5" y="302.1919">handleReadEvent(fd) → extract full frame</text><polygon fill="#181818" points="1032.5,332.3906,1042.5,336.3906,1032.5,340.3906,1036.5,336.3906" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="739.5" x2="1038.5" y1="336.3906" y2="336.3906"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="281" x="746.5" y="331.3247">parseCommand(json) → Command{LOGIN}</text><polygon fill="#181818" points="367.5,361.5234,357.5,365.5234,367.5,369.5234,363.5,365.5234" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="361.5" x2="1043.5" y1="365.5234" y2="365.5234"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="196" x="373.5" y="360.4575">processCommand(state, cmd)</text><rect fill="#EEEEEE" height="3" style="stroke:#EEEEEE;stroke-width:1.0;" width="1725.5" x="0" y="394.0898"/><line style="stroke:#000000;stroke-width:1.0;" x1="0" x2="1725.5" y1="394.0898" y2="394.0898"/><line style="stroke:#000000;stroke-width:1.0;" x1="0" x2="1725.5" y1="397.0898" y2="397.0898"/><rect fill="#EEEEEE" height="23.1328" style="stroke:#000000;stroke-width:2.0;" width="53" x="836.25" y="383.5234"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="34" x="842.25" y="399.5903">Auth</text><polygon fill="#181818" points="1157.5,433.7891,1167.5,437.7891,1157.5,441.7891,1161.5,437.7891" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="356.5" x2="1163.5" y1="437.7891" y2="437.7891"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="203" x="363.5" y="432.7231">loginUser(username, password)</text><polygon fill="#181818" points="1668.5,462.9219,1678.5,466.9219,1668.5,470.9219,1672.5,466.9219" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="1169.5" x2="1674.5" y1="466.9219" y2="466.9219"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="309" x="1176.5" y="461.856">findUser(username)  (prepared SELECT + index)</text><polygon fill="#181818" points="1180.5,492.0547,1170.5,496.0547,1180.5,500.0547,1176.5,496.0547" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1174.5" x2="1679.5" y1="496.0547" y2="496.0547"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="74" x="1186.5" y="490.9888">storedHash</text><line style="stroke:#181818;stroke-width:1.0;" x1="1169.5" x2="1211.5" y1="525.1875" y2="525.1875"/><line style="stroke:#181818;stroke-width:1.0;" x1="1211.5" x2="1211.5" y1="525.1875" y2="538.1875"/><line style="stroke:#181818;stroke-width:1.0;" x1="1170.5" x2="1211.5" y1="538.1875" y2="538.1875"/><polygon fill="#181818" points="1180.5,534.1875,1170.5,538.1875,1180.5,542.1875,1176.5,538.1875" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="104" x="1176.5" y="520.1216">verifyPassword()</text><polygon fill="#181818" points="367.5,563.3203,357.5,567.3203,367.5,571.3203,363.5,567.3203" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="361.5" x2="1168.5" y1="567.3203" y2="567.3203"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="102" x="373.5" y="562.2544">success | failure</text><path d="M272,582.3203 L336,582.3203 L336,589.4531 L326,599.4531 L272,599.4531 L272,582.3203 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.5;"/><rect fill="none" height="322.2656" style="stroke:#000000;stroke-width:1.5;" width="1413.5" x="272" y="582.3203"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="19" x="287" y="595.3872">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="61" x="351" y="594.5308">[success]</text><polygon fill="#181818" points="727.5,631.7188,737.5,635.7188,727.5,639.7188,731.5,635.7188" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="356.5" x2="733.5" y1="635.7188" y2="635.7188"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="171" x="363.5" y="615.52">state.authenticated = true</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="186" x="363.5" y="630.6528">state.username = username</text><polygon fill="#181818" points="1282.5,660.8516,1292.5,664.8516,1282.5,668.8516,1286.5,664.8516" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="356.5" x2="1288.5" y1="664.8516" y2="664.8516"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="201" x="363.5" y="659.7856">registerClient(username, state)</text><line style="stroke:#181818;stroke-width:1.0;" x1="1294.5" x2="1336.5" y1="693.9844" y2="693.9844"/><line style="stroke:#181818;stroke-width:1.0;" x1="1336.5" x2="1336.5" y1="693.9844" y2="706.9844"/><line style="stroke:#181818;stroke-width:1.0;" x1="1295.5" x2="1336.5" y1="706.9844" y2="706.9844"/><polygon fill="#181818" points="1305.5,702.9844,1295.5,706.9844,1305.5,710.9844,1301.5,706.9844" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="372" x="1301.5" y="688.9185">lock(clientsMutex); activeClients[username]=state; unlock</text><polygon fill="#181818" points="1032.5,732.1172,1042.5,736.1172,1032.5,740.1172,1036.5,736.1172" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="356.5" x2="1038.5" y1="736.1172" y2="736.1172"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="338" x="363.5" y="731.0513">serializeResponse(LOGIN_RESPONSE{success:true})</text><polygon fill="#181818" points="367.5,761.25,357.5,765.25,367.5,769.25,363.5,765.25" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="361.5" x2="1043.5" y1="765.25" y2="765.25"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="88" x="373.5" y="760.1841">jsonResponse</text><polygon fill="#181818" points="727.5,790.3828,737.5,794.3828,727.5,798.3828,731.5,794.3828" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="356.5" x2="733.5" y1="794.3828" y2="794.3828"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="359" x="363.5" y="789.3169">queueResponse(jsonResponse); epoll_ctl add EPOLLOUT</text><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="272" x2="1685.5" y1="803.3828" y2="803.3828"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="52" x="277" y="813.5933">[failure]</text><polygon fill="#181818" points="1032.5,834.3203,1042.5,838.3203,1032.5,842.3203,1036.5,838.3203" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="356.5" x2="1038.5" y1="838.3203" y2="838.3203"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="194" x="363.5" y="833.2544">serializeResponse(ERROR 401)</text><polygon fill="#181818" points="367.5,863.4531,357.5,867.4531,367.5,871.4531,363.5,867.4531" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="361.5" x2="1043.5" y1="867.4531" y2="867.4531"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="57" x="373.5" y="862.3872">jsonError</text><polygon fill="#181818" points="727.5,892.5859,737.5,896.5859,727.5,900.5859,731.5,896.5859" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="356.5" x2="733.5" y1="896.5859" y2="896.5859"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="328" x="363.5" y="891.52">queueResponse(jsonError); epoll_ctl add EPOLLOUT</text><rect fill="#EEEEEE" height="3" style="stroke:#EEEEEE;stroke-width:1.0;" width="1725.5" x="0" y="932.1523"/><line style="stroke:#000000;stroke-width:1.0;" x1="0" x2="1725.5" y1="932.1523" y2="932.1523"/><line style="stroke:#000000;stroke-width:1.0;" x1="0" x2="1725.5" y1="935.1523" y2="935.1523"/><rect fill="#EEEEEE" height="23.1328" style="stroke:#000000;stroke-width:2.0;" width="58" x="833.75" y="921.5859"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="39" x="839.75" y="937.6528">Flush</text><line style="stroke:#181818;stroke-width:1.0;" x1="356.5" x2="398.5" y1="975.8516" y2="975.8516"/><line style="stroke:#181818;stroke-width:1.0;" x1="398.5" x2="398.5" y1="975.8516" y2="988.8516"/><line style="stroke:#181818;stroke-width:1.0;" x1="357.5" x2="398.5" y1="988.8516" y2="988.8516"/><polygon fill="#181818" points="367.5,984.8516,357.5,988.8516,367.5,992.8516,363.5,988.8516" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="158" x="363.5" y="970.7856">epoll_wait() → EPOLLOUT</text><polygon fill="#181818" points="727.5,1013.9844,737.5,1017.9844,727.5,1021.9844,731.5,1017.9844" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="356.5" x2="733.5" y1="1017.9844" y2="1017.9844"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="308" x="363.5" y="1012.9185">handleWriteEvent() → send until EAGAIN / empty</text><polygon fill="#181818" points="362.5,1043.1172,352.5,1047.1172,362.5,1051.1172,358.5,1047.1172" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="356.5" x2="738.5" y1="1047.1172" y2="1047.1172"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="227" x="368.5" y="1042.0513">if empty → epoll_ctl drop EPOLLOUT</text><!--MD5=[a7346c861824e64bf8c1d4abbd4de0d2]
@startuml
title User Login

actor Client
participant "WorkerThread (W)" as W
participant "ClientState (sender)" as CS
participant ProtocolHandler as PH
participant AuthManager as AM
participant MessageRouter as MR
participant Database as DB

== TCP Send ==
Client -> W: [len][{"type":"LOGIN","username","password"}]

== Read/Parse ==
activate W
W -> W: epoll_wait() → EPOLLIN
W -> CS: handleReadEvent(fd) → extract full frame
CS -> PH: parseCommand(json) → Command{LOGIN}
PH -> W: processCommand(state, cmd)

== Auth ==
W -> AM: loginUser(username, password)
AM -> DB: findUser(username)  (prepared SELECT + index)
DB - -> AM: storedHash
AM -> AM: verifyPassword()
AM - -> W: success | failure

alt success
  W -> CS: state.authenticated = true\nstate.username = username
  W -> MR: registerClient(username, state)
  MR -> MR: lock(clientsMutex); activeClients[username]=state; unlock
  ' Optional: fetch undelivered now or defer to post-login phase
  W -> PH: serializeResponse(LOGIN_RESPONSE{success:true})
  PH - -> W: jsonResponse
  W -> CS: queueResponse(jsonResponse); epoll_ctl add EPOLLOUT
else failure
  W -> PH: serializeResponse(ERROR 401)
  PH - -> W: jsonError
  W -> CS: queueResponse(jsonError); epoll_ctl add EPOLLOUT
end

== Flush ==
W -> W: epoll_wait() → EPOLLOUT
W -> CS: handleWriteEvent() → send until EAGAIN / empty
CS -> W: if empty → epoll_ctl drop EPOLLOUT
deactivate W
@enduml

@startuml
title User Login

actor Client
participant "WorkerThread (W)" as W
participant "ClientState (sender)" as CS
participant ProtocolHandler as PH
participant AuthManager as AM
participant MessageRouter as MR
participant Database as DB

== TCP Send ==
Client -> W: [len][{"type":"LOGIN","username","password"}]

== Read/Parse ==
activate W
W -> W: epoll_wait() → EPOLLIN
W -> CS: handleReadEvent(fd) → extract full frame
CS -> PH: parseCommand(json) → Command{LOGIN}
PH -> W: processCommand(state, cmd)

== Auth ==
W -> AM: loginUser(username, password)
AM -> DB: findUser(username)  (prepared SELECT + index)
DB - -> AM: storedHash
AM -> AM: verifyPassword()
AM - -> W: success | failure

alt success
  W -> CS: state.authenticated = true\nstate.username = username
  W -> MR: registerClient(username, state)
  MR -> MR: lock(clientsMutex); activeClients[username]=state; unlock
  W -> PH: serializeResponse(LOGIN_RESPONSE{success:true})
  PH - -> W: jsonResponse
  W -> CS: queueResponse(jsonResponse); epoll_ctl add EPOLLOUT
else failure
  W -> PH: serializeResponse(ERROR 401)
  PH - -> W: jsonError
  W -> CS: queueResponse(jsonError); epoll_ctl add EPOLLOUT
end

== Flush ==
W -> W: epoll_wait() → EPOLLOUT
W -> CS: handleWriteEvent() → send until EAGAIN / empty
CS -> W: if empty → epoll_ctl drop EPOLLOUT
deactivate W
@enduml

PlantUML version 1.2022.7(Mon Aug 22 17:01:30 UTC 2022)
(GPL source distribution)
Java Runtime: OpenJDK Runtime Environment
JVM: OpenJDK 64-Bit Server VM
Default Encoding: UTF-8
Language: en
Country: null
--></g></svg>